<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tư vấn Răng với Gemini</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #f3f4f6;
      }
    </style>
  </head>
  <body class="flex items-center justify-center min-h-screen p-4">
    <div
      class="bg-white p-8 rounded-xl shadow-lg w-full max-w-2xl border border-gray-200"
    >
      <h1 class="text-3xl font-bold text-gray-800 text-center mb-6">
        Tư vấn Răng với AI của Dũng
      </h1>

      <div class="mb-6">
        <label
          for="image-upload"
          class="block text-sm font-medium text-gray-700 mb-2"
          >Tải lên ảnh X-quang răng của bạn (tùy chọn):</label
        >
        <div
          class="flex items-center justify-center w-full"
          id="upload-area-container"
        >
          <label
            for="image-upload"
            class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100 transition-colors duration-200"
          >
            <div class="flex flex-col items-center justify-center pt-5 pb-6">
              <svg
                class="w-8 h-8 mb-4 text-gray-500"
                aria-hidden="true"
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 20 16"
              >
                <path
                  stroke="currentColor"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M13 13h3a3 3 0 0 0 0-6h-.025A5.56 5.56 0 0 0 16 6.5 5.5 5.5 0 0 0 5.207 5.207A2.88 2.88 0 0 0 5 6.5a2.88 2.88 0 0 0-.293 1.793m-2.126-.412C1.884 8.718 1 9.877 1 11.134 1 13.061 2.56 14.5 4.5 14.5H16"
                />
              </svg>
              <p class="mb-2 text-sm text-gray-500">
                <span class="font-semibold">Nhấn để tải lên</span> hoặc kéo và
                thả
              </p>
              <p class="text-xs text-gray-500">JPG, PNG, JPEG (Tối đa 5MB)</p>
            </div>
            <input
              id="image-upload"
              type="file"
              class="hidden"
              accept=".jpg, .jpeg, .png"
            />
          </label>
        </div>
        <div id="image-preview-container" class="mt-4 hidden">
          <img
            id="image-preview"
            src="#"
            alt="Xem trước ảnh đã tải lên"
            class="max-w-full h-auto rounded-lg shadow-md"
          />
          <p
            id="image-name"
            class="mt-2 text-sm text-gray-700 text-center truncate"
          ></p>
        </div>
      </div>

      <div class="mb-6">
        <label
          for="prompt-input"
          class="block text-sm font-medium text-gray-700 mb-2"
          >Nhập câu hỏi của bạn (cần có để gửi):</label
        >
        <textarea
          id="prompt-input"
          rows="4"
          class="block w-full px-4 py-2 text-gray-900 border border-gray-300 rounded-lg bg-gray-50 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200"
          placeholder="Ví dụ: 'Bạn có thể phân tích bức ảnh X-quang này không? Răng của tôi có vấn đề gì không?'"
        ></textarea>
      </div>

      <div class="flex justify-center mb-6">
        <button
          id="send-button"
          class="w-full sm:w-auto px-6 py-3 text-white bg-blue-600 rounded-lg font-semibold hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-colors duration-200 shadow-md disabled:bg-gray-400"
        >
          Gửi yêu cầu
        </button>
      </div>

      <div
        class="bg-gray-100 p-6 rounded-lg border border-gray-200 shadow-inner min-h-[150px]"
      >
        <h2 class="text-lg font-semibold text-gray-800 mb-2">Câu trả lời:</h2>
        <div id="response-area" class="text-gray-700 whitespace-pre-wrap">
          <p>
            Nhập câu hỏi của bạn, tải ảnh (nếu có) và nhấn "Gửi" để bắt đầu.
          </p>
        </div>
        <div id="loading-indicator" class="hidden text-center text-gray-500">
          Đang tạo câu trả lời...
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const promptInput = document.getElementById("prompt-input");
        const imageUpload = document.getElementById("image-upload");
        const sendButton = document.getElementById("send-button");
        const responseArea = document.getElementById("response-area");
        const loadingIndicator = document.getElementById("loading-indicator");
        const imagePreview = document.getElementById("image-preview");
        const imagePreviewContainer = document.getElementById(
          "image-preview-container"
        );
        const imageName = document.getElementById("image-name");
        const uploadAreaContainer = document.getElementById(
          "upload-area-container"
        );

        let imageFile = null;

        // Xử lý xem trước ảnh khi người dùng chọn file
        imageUpload.addEventListener("change", (event) => {
          imageFile = event.target.files[0];
          if (imageFile) {
            const reader = new FileReader();
            reader.onload = (e) => {
              imagePreview.src = e.target.result;
              imagePreviewContainer.classList.remove("hidden");
              imageName.textContent = imageFile.name;
              uploadAreaContainer.classList.add("hidden");
            };
            reader.readAsDataURL(imageFile);
          } else {
            imagePreview.src = "#";
            imagePreviewContainer.classList.add("hidden");
            uploadAreaContainer.classList.remove("hidden");
          }
        });

        // Xử lý sự kiện khi nút "Gửi" được nhấn
        sendButton.addEventListener("click", async () => {
          const userPrompt = promptInput.value.trim();
          if (!userPrompt) {
            alert("Vui lòng nhập câu hỏi.");
            return;
          }

          loadingIndicator.classList.remove("hidden");
          responseArea.innerHTML = "";
          sendButton.disabled = true;

          try {
            // Thay thế bằng API key Gemini của bạn
            const apiKey = "AIzaSyCSigYF38QyoAi7YD_DaN1C3ylU65SDL6w";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const parts = [
              {
                text: `Bạn là một trợ lý tư vấn nha khoa. Hãy trả lời các câu hỏi về sức khỏe răng miệng, phân tích các hình ảnh X-quang về răng nếu được cung cấp và đưa ra lời khuyên chung. Tuy nhiên, hãy luôn nhấn mạnh rằng bạn chỉ là một công cụ AI và không thể thay thế chẩn đoán của nha sĩ chuyên nghiệp. Bất kỳ phân tích nào cũng chỉ mang tính chất tham khảo. Nếu câu hỏi không liên quan đến nha khoa hoặc sức khỏe răng miệng, hãy lịch sự từ chối và yêu cầu hỏi lại về chủ đề đó. Câu hỏi: ${userPrompt}`,
              },
            ];

            if (imageFile) {
              const base64Image = await new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(",")[1]);
                reader.readAsDataURL(imageFile);
              });

              parts.push({
                inlineData: {
                  mimeType: imageFile.type,
                  data: base64Image,
                },
              });
            }

            const payload = { contents: [{ parts }] };

            let response;
            let delay = 1000;
            const maxRetries = 5;
            let retries = 0;

            while (retries < maxRetries) {
              try {
                response = await fetch(apiUrl, {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify(payload),
                });

                if (response.status === 429) {
                  console.log(
                    `API rate limit exceeded. Retrying in ${
                      delay / 1000
                    } seconds...`
                  );
                  await new Promise((res) => setTimeout(res, delay));
                  delay *= 2;
                  retries++;
                } else {
                  break;
                }
              } catch (error) {
                console.error("Lỗi khi gọi API:", error);
                break;
              }
            }

            if (response.status === 429) {
              throw new Error(
                "Đã vượt quá giới hạn API. Vui lòng thử lại sau."
              );
            }

            const result = await response.json();

            if (
              result.candidates &&
              result.candidates.length > 0 &&
              result.candidates[0].content &&
              result.candidates[0].content.parts &&
              result.candidates[0].content.parts.length > 0
            ) {
              const text = result.candidates[0].content.parts[0].text;
              responseArea.innerText = text;
            } else {
              responseArea.innerText =
                "Không thể lấy câu trả lời. Vui lòng thử lại.";
            }
          } catch (error) {
            console.error("Lỗi:", error);
            responseArea.innerText = `Đã xảy ra lỗi: ${error.message}`;
          } finally {
            loadingIndicator.classList.add("hidden");
            sendButton.disabled = false;
          }
        });
      });
    </script>
  </body>
</html>
